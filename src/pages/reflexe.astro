---
import Layout from '../layouts/Layout.astro';

const title = "Test de Reflexe Pro - Manualul.ro";
const description = "MÄƒsoarÄƒ-È›i viteza de reacÈ›ie Ã®n milisecunde. EÈ™ti pregÄƒtit pentru Esports? TesteazÄƒ-È›i reflexele acum.";
---

<Layout title={title} description={description}>
    <main class="min-h-screen bg-gray-950 flex flex-col items-center justify-center p-4">
        <div id="game-container" class="w-full max-w-5xl aspect-video md:aspect-[21/9] bg-gray-900 rounded-[40px] shadow-2xl border border-gray-800 flex flex-col items-center justify-center cursor-pointer select-none relative overflow-hidden">
            <div id="game-content" class="text-center z-10 pointer-events-none">
                <div id="game-icon" class="text-7xl mb-10">âš¡</div>
                <h1 id="game-text" class="text-4xl md:text-6xl font-black text-white px-6 leading-tight">
                    Click oriunde pentru a Ã®ncepe
                </h1>
                <p id="game-subtext" class="mt-4 text-gray-400 font-medium text-lg">
                    Vei face 5 Ã®ncercÄƒri pentru a calcula media
                </p>
            </div>

            <!-- Overlay pentru rezultate finale -->
            <div id="final-results" class="hidden absolute inset-0 bg-gray-950 z-20 flex flex-col items-center justify-center p-8 text-center">
                <div id="rank-badge" class="mb-4"></div>
                <h2 id="rank-title" class="text-4xl md:text-6xl font-black text-white mb-2"></h2>
                <p id="rank-desc" class="text-xl text-cyan-400 font-bold mb-8"></p>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 w-full max-w-2xl">
                    <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800">
                        <p class="text-gray-500 text-xs font-black uppercase tracking-widest px-1">Media ta</p>
                        <p id="avg-result" class="text-3xl font-black text-white">0ms</p>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800">
                        <p class="text-gray-500 text-xs font-black uppercase tracking-widest px-1">Cel mai bun</p>
                        <p id="best-result" class="text-3xl font-black text-green-400">0ms</p>
                    </div>
                </div>

                <button id="restart-btn" class="px-10 py-4 bg-white text-gray-950 font-black rounded-2xl hover:scale-105 transition-transform shadow-xl">
                    ÃŽNCEARCÄ‚ DIN NOU
                </button>
            </div>
        </div>

        <!-- Istoric -->
        <div class="mt-12 w-full max-w-md">
            <h3 class="text-gray-500 text-xs font-black uppercase tracking-[0.3em] mb-4 text-center">Istoric Ã®ncercÄƒri</h3>
            <div class="bg-gray-900 rounded-3xl border border-gray-800 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-800">
                            <th class="p-4 text-xs font-black text-gray-500 uppercase">Tura</th>
                            <th class="p-4 text-xs font-black text-gray-500 uppercase text-right">Rezultat</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr class="border-b border-gray-800/50">
                            <td class="p-4 text-gray-600">#1</td>
                            <td class="p-4 text-gray-600 text-right">---</td>
                        </tr>
                        <tr class="border-b border-gray-800/50">
                            <td class="p-4 text-gray-600">#2</td>
                            <td class="p-4 text-gray-600 text-right">---</td>
                        </tr>
                        <tr class="border-b border-gray-800/50">
                            <td class="p-4 text-gray-600">#3</td>
                            <td class="p-4 text-gray-600 text-right">---</td>
                        </tr>
                        <tr class="border-b border-gray-800/50">
                            <td class="p-4 text-gray-600">#4</td>
                            <td class="p-4 text-gray-600 text-right">---</td>
                        </tr>
                        <tr>
                            <td class="p-4 text-gray-600">#5</td>
                            <td class="p-4 text-gray-600 text-right">---</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script is:inline>
        const container = document.getElementById('game-container');
        const icon = document.getElementById('game-icon');
        const text = document.getElementById('game-text');
        const subtext = document.getElementById('game-subtext');
        const historyBody = document.getElementById('history-body');
        const finalResults = document.getElementById('final-results');
        const restartBtn = document.getElementById('restart-btn');

        const avgResult = document.getElementById('avg-result');
        const bestResult = document.getElementById('best-result');
        const rankTitle = document.getElementById('rank-title');
        const rankDesc = document.getElementById('rank-desc');
        const rankBadge = document.getElementById('rank-badge');

        let state = 'initial'; // initial, waiting, ready, result
        let attempts = [];
        let startTime = 0;
        let waitTimer = null;

        function updateHistory() {
            const rows = historyBody.querySelectorAll('tr');
            rows.forEach((row, i) => {
                const cell = row.querySelectorAll('td')[1];
                if (attempts[i] !== undefined) {
                    cell.textContent = `${attempts[i]}ms`;
                    cell.className = 'p-4 text-white font-bold text-right';
                    row.className = 'border-b border-gray-800/50 bg-gray-800/20';
                } else {
                    cell.textContent = '---';
                    cell.className = 'p-4 text-gray-600 text-right';
                    row.className = 'border-b border-gray-800/50';
                }
            });
        }

        function getRank(avg) {
            if (avg < 160) return { title: "Zeul Reflexelor", desc: "Esports Ready", badge: "ðŸ†" };
            if (avg < 200) return { title: "Pro Player", desc: "Faceit lvl 10", badge: "âš”ï¸" };
            if (avg < 250) return { title: "Gamer Solid", desc: "Gold Nova", badge: "ðŸ”«" };
            if (avg < 300) return { title: "Casual", desc: "Silver", badge: "ðŸ¢" };
            return { title: "NPC", desc: "Ai nevoie de o cafea", badge: "â˜•" };
        }

        function showFinal() {
            const avg = Math.round(attempts.reduce((a, b) => a + b, 0) / attempts.length);
            const best = Math.min(...attempts);
            const rank = getRank(avg);

            avgResult.textContent = `${avg}ms`;
            bestResult.textContent = `${best}ms`;
            rankTitle.textContent = rank.title;
            rankDesc.textContent = rank.desc;
            rankBadge.innerHTML = `<span class="text-7xl">${rank.badge}</span>`;

            finalResults.classList.remove('hidden');
        }

        function startWait() {
            state = 'waiting';
            container.style.backgroundColor = '#dc2626'; // Red-600 (RoÈ™u Aprins)
            container.classList.remove('bg-gray-900', 'bg-green-500');
            icon.textContent = 'ðŸ›‘';
            text.textContent = 'AÈ™teaptÄƒ verdele...';
            subtext.textContent = 'DacÄƒ dai click acum, vei fi penalizat.';

            const waitTime = 1500 + Math.random() * 3500;
            waitTimer = setTimeout(() => {
                state = 'ready';
                container.style.backgroundColor = '#00ff41'; // Neon Green
                icon.textContent = 'âš¡';
                text.textContent = 'CLICK!';
                subtext.textContent = 'ACUM!';
                startTime = performance.now();
            }, waitTime);
        }

        function handleClick() {
            if (state === 'initial') {
                startWait();
            } else if (state === 'waiting') {
                clearTimeout(waitTimer);
                state = 'result';
                container.style.backgroundColor = '#111827'; // Gray-900
                icon.textContent = 'âš ï¸';
                text.textContent = 'Prea devreme! Penalizare.';
                subtext.textContent = 'Click pentru a reÃ®ncerca tura.';
            } else if (state === 'ready') {
                const endTime = performance.now();
                const diff = Math.round(endTime - startTime);
                attempts.push(diff);
                updateHistory();

                state = 'result';
                container.style.backgroundColor = '#111827'; // Gray-900
                icon.textContent = 'ðŸŽ¯';
                text.textContent = `${diff}ms`;

                if (attempts.length >= 5) {
                    showFinal();
                } else {
                    subtext.textContent = `Bun! Click pentru tura ${attempts.length + 1}/5`;
                }
            } else if (state === 'result') {
                if (attempts.length < 5) {
                    startWait();
                }
            }
        }

        container.addEventListener('click', handleClick);
        restartBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            attempts = [];
            state = 'initial';
            updateHistory();
            finalResults.classList.add('hidden');
            container.style.backgroundColor = '#111827'; // Gray-900
            icon.textContent = 'âš¡';
            text.textContent = 'Click oriunde pentru a Ã®ncepe';
            subtext.textContent = 'Vei face 5 Ã®ncercÄƒri pentru a calcula media';
        });
    </script>
</Layout>
