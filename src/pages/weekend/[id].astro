---
import Layout from '../../layouts/Layout.astro';
import WhatsAppButton from '../../components/WhatsAppButton.astro';
import records from '../../data/weekend.json';
import { getCentralData } from '../../lib/api';

const { id } = Astro.params;
const info = records.find(r => r.id === id);

if (!info) {
    return Astro.redirect('/404');
}

const centralData = await getCentralData();
const gasolinePrice = centralData.fuel.gasoline;
---

<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Buget Weekend " + info.destinatie,
  "url": "https://manualul.ro/weekend/" + info.id,
  "description": "Calculator de costuri turistice pentru " + info.destinatie + ". Include preÈ›uri medii la cazare, mÃ¢ncare È™i transport.",
  "applicationCategory": "TravelApplication",
  "operatingSystem": "Any",
  "contentLocation": {
    "@type": "Place",
    "name": info.destinatie,
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "RO",
      "addressRegion": info.regiune
    }
  },
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "RON"
  }
})}>
</script>

<Layout 
    title={`Buget Weekend: ${info.destinatie}`}
    description={`Calculator personalizat pentru ${info.destinatie}. AjusteazÄƒ costurile È™i aflÄƒ bugetul total.`}
>
    <main class="max-w-4xl mx-auto px-4 pb-20">
        <nav class="py-6">
            <a href="/weekend" class="text-sm font-bold text-orange-700 hover:underline">â† Ãnapoi la listÄƒ</a>
        </nav>

        <header class="mb-10 text-center">
            <h1 class="text-4xl md:text-5xl font-black text-gray-900">{info.destinatie}</h1>
            <p class="text-orange-600 font-bold uppercase tracking-widest text-xs mt-2">{info.regiune}</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-[40px] shadow-2xl border border-orange-100 overflow-hidden">
                    
                    <div class="p-8 bg-gray-900 text-white grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-2 opacity-50">Persoane</label>
                            <input type="number" id="persInput" value="2" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white font-bold outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-2 opacity-50">NopÈ›i</label>
                            <input type="number" id="noptiInput" value="2" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white font-bold outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-2 opacity-50">DistanÈ›Äƒ KM</label>
                            <input type="number" id="kmInput" value={info.distanta_ref * 2} class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white font-bold outline-none">
                        </div>
                    </div>

                    <div class="p-8 md:p-12 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-orange-600 uppercase">Cazare/noapte</label>
                                <input type="number" id="costCazareInput" value={info.pret_cazare} class="w-full border-2 border-gray-100 rounded-2xl p-4 font-black text-xl outline-none focus:border-orange-500">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-orange-600 uppercase">MÃ¢ncare/zi/pers</label>
                                <input type="number" id="costMancareInput" value={info.pret_masa} class="w-full border-2 border-gray-100 rounded-2xl p-4 font-black text-xl outline-none focus:border-orange-500">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-orange-600 uppercase">DistracÈ›ie/zi/pers</label>
                                <input type="number" id="costDistractieInput" value="100" class="w-full border-2 border-gray-100 rounded-2xl p-4 font-black text-xl outline-none focus:border-orange-500">
                            </div>
                        </div>

                        <div class="mt-12 pt-10 border-t-4 border-dashed border-gray-50 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <p class="text-[10px] font-black uppercase text-gray-400">Total Estimat</p>
                                <p class="text-6xl font-black text-orange-600" id="totalDisplay">0 Lei</p>
                            </div>
                            <div class="text-right text-xs text-gray-500 space-y-1">
                                <p>ğŸ”¥ BenzinÄƒ: <span id="benzinaSum" class="font-bold text-gray-800">0 Lei</span></p>
                                <p>ğŸ¨ Cazare: <span id="cazareSum" class="font-bold text-gray-800">0 Lei</span></p>
                                <p>ğŸ´ MasÄƒ/Play: <span id="masaSum" class="font-bold text-gray-800">0 Lei</span></p>
                            </div>
                        </div>

                        <WhatsAppButton idDesktop="whatsappBtn" idMobile="whatsappBtnFloating" class="mt-8" />
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-900 text-white p-8 rounded-[40px]">
                    <h3 class="font-bold mb-4">AtracÈ›ii</h3>
                    <p class="text-sm text-gray-400 italic mb-4">"{info.atractii}"</p>
                    <div class="text-xs text-orange-300">ğŸ’¡ {info.tips}</div>
                </div>
                <div class="bg-orange-50 p-8 rounded-[40px] border border-orange-100">
                    <p class="text-sm text-orange-800 leading-relaxed">{info.descriere}</p>
                </div>
            </div>
        </div>

        <footer class="mt-12 flex items-center justify-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            Date live: BenzinÄƒ: {centralData.fuel.gasoline.toFixed(2)} RON | Actualizat la: {centralData.updated}
        </footer>
    </main>

<script is:inline define:vars={{ dest: info.destinatie, gasolinePrice }}>
    // PreluÄƒm elementul buton
    const btnWhatsapp = document.getElementById('whatsappBtn');
    const btnWhatsappFloating = document.getElementById('whatsappBtnFloating');

    // FuncÈ›ie simplÄƒ de citire valori
    function val(id) {
        const el = document.getElementById(id);
        return el ? (parseFloat(el.value) || 0) : 0;
    }

    // FuncÈ›ia Principala
    function updateCalculator() {
        // 1. Citim datele
        const p = val('persInput');
        const n = val('noptiInput');
        const k = val('kmInput');
        const pretCazare = val('costCazareInput');
        const pretMancare = val('costMancareInput');
        const pretDistractie = val('costDistractieInput');

        // 2. Calcule
        const totalCazare = n * pretCazare;
        const totalMasa = (n + 1) * p * (pretMancare + pretDistractie);
        const totalBenzina = (k / 100) * 8 * gasolinePrice;
        const total = Math.round(totalCazare + totalMasa + totalBenzina);

        // 3. Actualizam ecranul
        const dispCazare = document.getElementById('cazareSum');
        const dispMasa = document.getElementById('masaSum');
        const dispBenzina = document.getElementById('benzinaSum');
        const dispTotal = document.getElementById('totalDisplay');

        if(dispCazare) dispCazare.innerText = Math.round(totalCazare).toLocaleString() + " Lei";
        if(dispMasa) dispMasa.innerText = Math.round(totalMasa).toLocaleString() + " Lei";
        if(dispBenzina) dispBenzina.innerText = Math.round(totalBenzina).toLocaleString() + " Lei";
        if(dispTotal) dispTotal.innerText = total.toLocaleString() + " Lei";

        // 4. ACTUALIZARE LINK WHATSAPP (Fix pentru Mobil)
        const mesaj = `Am calculat bugetul pentru o excursie Ã®n ${dest} pe Manualul.ro ğŸš—\nTotal estimat: ${total.toLocaleString()} Lei pentru ${p} persoane (${n} nopÈ›i). Vezi È™i tu: ${window.location.href}`;
        const finalLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(mesaj)}`;

        if (btnWhatsapp) btnWhatsapp.href = finalLink;
        if (btnWhatsappFloating) btnWhatsappFloating.href = finalLink;
    }

    // 5. Pornim ascultatorii
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', updateCalculator);
    });

    // 6. Rulam imediat
    updateCalculator();
</script>

</Layout>
